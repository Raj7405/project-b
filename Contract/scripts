const hre = require("hardhat");
require('dotenv').config();
const fs = require('fs');
const path = require('path');

async function main() {
  console.log("\nüöÄ Starting BSC Testnet Deployment...\n");
  
  // Check environment variables
  if (!process.env.DEPLOYER_PRIVATE_KEY) {
    throw new Error("‚ùå DEPLOYER_PRIVATE_KEY not found in .env file");
  }

  const [deployer] = await hre.ethers.getSigners();
  console.log("üìù Deploying contracts with account:", deployer.address);
  
  const balance = await hre.ethers.provider.getBalance(deployer.address);
  console.log("üí∞ Account balance:", hre.ethers.formatEther(balance), "BNB\n");

  if (balance === 0n) {
    throw new Error("‚ùå Insufficient BNB balance. Please fund your account with testnet BNB.");
  }

  let tokenAddress = process.env.TOKEN_ADDRESS;
  let isMockToken = false;

  // Step 1: Deploy or use existing token
  if (!tokenAddress || tokenAddress === "0xYOUR_TOKEN_ADDRESS") {
    console.log("üìù Step 1: Deploying Mock ERC20 Token (for testing)...");
    const ERC20Mock = await hre.ethers.getContractFactory("ERC20Mock");
    const token = await ERC20Mock.deploy(
      "Test USDT",
      "TUSDT",
      deployer.address,
      hre.ethers.parseUnits("1000000", 18) // 1 million tokens with 18 decimals
    );
    await token.waitForDeployment();
    tokenAddress = await token.getAddress();
    isMockToken = true;
    console.log("‚úÖ Mock ERC20 Token deployed to:", tokenAddress);
    console.log("   Token Name: Test USDT (TUSDT)");
    console.log("   Decimals: 18");
    console.log("   Initial Supply: 1,000,000 TUSDT\n");
  } else {
    console.log("üìù Step 1: Using existing token address:", tokenAddress);
    console.log("   (Make sure this token has decimals() function)\n");
  }

  // Step 2: Get company wallet address
  const companyWallet = process.env.COMPANY_WALLET || deployer.address;
  if (companyWallet === "0xYOUR_COMPANY_WALLET_ADDRESS") {
    console.log("‚ö†Ô∏è  Warning: Using deployer address as company wallet");
    console.log("   Set COMPANY_WALLET in .env for production\n");
  }
  console.log("üìù Step 2: Company Wallet:", companyWallet);

  // Step 3: Deploy MLMSystem Contract
  console.log("\nüìù Step 3: Deploying MLMSystem Contract...");
  
  const MLMSystem = await hre.ethers.getContractFactory("MLMSystem");
  console.log("   Deploying contract (this may take a minute)...");
  
  const mlmSystem = await MLMSystem.deploy(
    tokenAddress,
    companyWallet
  );

  await mlmSystem.waitForDeployment();
  const contractAddress = await mlmSystem.getAddress();
  
  console.log("‚úÖ MLMSystem deployed to:", contractAddress);

  // Get contract configuration
  const entryPrice = await mlmSystem.entryPrice();
  const retopupPrice = await mlmSystem.retopupPrice();
  const directIncome = await mlmSystem.directIncome();
  const companyFee = await mlmSystem.companyFee();
  const tokenDecimals = await mlmSystem.tokenDecimals();

  console.log("\nüìã Contract Configuration:");
  console.log("   Entry Price:", hre.ethers.formatUnits(entryPrice, tokenDecimals), "tokens");
  console.log("   Retopup Price:", hre.ethers.formatUnits(retopupPrice, tokenDecimals), "tokens");
  console.log("   Direct Income:", hre.ethers.formatUnits(directIncome, tokenDecimals), "tokens");
  console.log("   Company Fee:", hre.ethers.formatUnits(companyFee, tokenDecimals), "tokens");
  console.log("   Token Decimals:", tokenDecimals.toString());

  // Step 4: Save deployment info
  console.log("\nüìù Step 4: Saving deployment information...");
  
  const deploymentsDir = path.join(__dirname, '../deployments');
  if (!fs.existsSync(deploymentsDir)) {
    fs.mkdirSync(deploymentsDir, { recursive: true });
  }
  
  const deploymentInfo = {
    network: hre.network.name,
    chainId: hre.network.config.chainId,
    contractAddress: contractAddress,
    tokenAddress: tokenAddress,
    isMockToken: isMockToken,
    deployer: deployer.address,
    companyWallet: companyWallet,
    entryPrice: entryPrice.toString(),
    retopupPrice: retopupPrice.toString(),
    directIncome: directIncome.toString(),
    companyFee: companyFee.toString(),
    tokenDecimals: tokenDecimals.toString(),
    timestamp: new Date().toISOString(),
    explorerUrl: hre.network.config.chainId === 97 
      ? `https://testnet.bscscan.com/address/${contractAddress}`
      : `https://explorer.example.com/address/${contractAddress}`
  };
  
  const deploymentFile = path.join(deploymentsDir, `${hre.network.name}-latest.json`);
  fs.writeFileSync(deploymentFile, JSON.stringify(deploymentInfo, null, 2));
  
  console.log("‚úÖ Deployment info saved to", deploymentFile);

  // Step 5: Display summary
  console.log("\n" + "=".repeat(80));
  console.log("üéâ DEPLOYMENT SUCCESSFUL!");
  console.log("=".repeat(80));
  console.log("\nüìã Deployment Summary:\n");
  console.log("Network:", hre.network.name);
  console.log("Chain ID:", hre.network.config.chainId);
  console.log("MLMSystem Contract:", contractAddress);
  console.log("Token Contract:", tokenAddress, isMockToken ? "(Mock Token)" : "");
  console.log("Company Wallet:", companyWallet);
  
  if (hre.network.config.chainId === 97) {
    console.log("\nüîç View on BSC Testnet Explorer:");
    console.log("   Contract:", `https://testnet.bscscan.com/address/${contractAddress}`);
    console.log("   Token:", `https://testnet.bscscan.com/address/${tokenAddress}`);
  }

  console.log("\nüìã Frontend Configuration (.env.local):\n");
  console.log(`NEXT_PUBLIC_CONTRACT_ADDRESS=${contractAddress}`);
  console.log(`NEXT_PUBLIC_TOKEN_ADDRESS=${tokenAddress}`);
  console.log(`NEXT_PUBLIC_RPC_URL=${process.env.BSC_TESTNET_RPC || "https://data-seed-prebsc-1-s1.binance.org:8545/"}`);
  console.log(`NEXT_PUBLIC_CHAIN_ID=${hre.network.config.chainId}`);
  console.log("\n" + "=".repeat(80));
  
  console.log("\nüìù Next Steps:");
  console.log("1. ‚úÖ Copy the contract addresses above");
  console.log("2. üîç Verify the contract on BSC Testnet Explorer");
  console.log("3. üß™ Test the contract functions");
  if (isMockToken) {
    console.log("4. üí∞ Users need to get test tokens from the mock contract");
    console.log("   - Call mint() function on token contract to get test tokens");
  }
  console.log("5. üöÄ Update frontend .env.local with the addresses above");
  console.log("\n" + "=".repeat(80));
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error("\n‚ùå Deployment failed:");
    console.error(error);
    process.exit(1);
  });

